---
title: >
  使用 asp.net
  mvc的Filter来验证Forms(判断是否登录,角色权限以及错误处理)
author: mathewxiang
layout: post
permalink: >
  /2010/09/%e4%bd%bf%e7%94%a8-asp-net-mvc%e7%9a%84filter%e6%9d%a5%e9%aa%8c%e8%af%81forms%e5%88%a4%e6%96%ad%e6%98%af%e5%90%a6%e7%99%bb%e5%bd%95%e8%a7%92%e8%89%b2%e6%9d%83%e9%99%90%e4%bb%a5%e5%8f%8a%e9%94%99/
categories:
  - 默认
---
### 使用 asp.net mvc的Filter来验证Forms(判断是否登录,角色权限以及错误处理)

asp.net mvc里的Filter真的是个很好的东西.   
之前看教程每次看到讲解Filter的地方总有模糊.   
今天在做测试项目的时候.管理员后台管理的时候.我在每个Action里都先验证了一下是否登录.   
结果做了7,8个Action的时候发现这样是不是有点太累了?脑袋里马上灵光一闪.Filter不是有个内置验证身份的吗?   
马上搜索,一翻查找之后才发现内置的这个身份验证是争对membership的.而我使用的Forms验证..   
咋办..继续搜呗.功夫不负有心人..终于让我给找到了.经过测试,使用很不错.   
7,8个action里的if (!Request.IsAuthenticated)终于可以变成一句了..这样我就可以更安心的写Action了.   
不说了.贴代码.   
先是自定义的 Filter:

<pre><p>
  <p>
    using System;
    <br />using System.Data;
    <br />using System.Configuration;
    <br />using System.Linq;
    <br />using System.Web;
    <br />using System.Web.Mvc;
    <br />using System.Web.Security;
    <br />using System.Web.Routing;
    <br />
    <br />namespace cml.web.Filters
    <br />{
    <br />    /// <summary>
    <br />    /// 角色认证
    <br />    /// </summary>
    <br />    public class VaildateLoginRoleAttribute : ActionFilterAttribute
    <br />    {
    <br />        /// <summary>
    <br />        /// 角色名称
    <br />        /// </summary>
    <br />        public string Role { get; set; }
    <br />
    <br />        public override void OnActionExecuting(ActionExecutingContext filterContext)
    <br />        {
    <br />            if (!string.IsNullOrEmpty(Role))
    <br />            {
    <br />                if (!filterContext.HttpContext.User.Identity.IsAuthenticated)
    <br />                {
    <br />                    string redirectOnSuccess = filterContext.HttpContext.Request.RawUrl;
    <br />                    string redirectUrl = string.Format("?ReturnUrl={0}", redirectOnSuccess);
    <br />                    string loginUrl = FormsAuthentication.LoginUrl + redirectUrl;
    <br />                    filterContext.HttpContext.Response.Redirect(loginUrl, true);
    <br />                }
    <br />                else
    <br />                {
    <br />                    //判断是否存在角色
    <br />                    FormsIdentity id = (FormsIdentity)HttpContext.Current.User.Identity;
    <br />                    FormsAuthenticationTicket ticket = id.Ticket;
    <br />                    string roles = ticket.UserData;
    <br />                    string[] chkRoles = this.Role.Split(',');
    <br />                    bool isAuthorized = false;
    <br />                    if (Array.IndexOf(chkRoles, roles) > -1)
    <br />                        isAuthorized = true;
    <br />                    else
    <br />                        isAuthorized = false;
    <br />
    <br />                    if (!isAuthorized)
    <br />                        filterContext.Result = new RedirectToRouteResult("Default", new RouteValueDictionary(new { controller = "Manage", action = "AdminLogin" }));
    <br />                    //throw new UnauthorizedAccessException("你没有权限访问该页面");
    <br />                }
    <br />            }
    <br />            else
    <br />            {
    <br />                throw new InvalidOperationException("没有指定角色");
    <br />            }
    <br />        }
    <br />    }
    <br />
    <br />    //错误验证
    <br />    //public class ErrorAttribute : ActionFilterAttribute
    <br />    //{
    <br />    //    public override void OnActionExecuted(ActionExecutedContext filterContext) // OnActionExecuted表示在Action执行之后
    <br />    //    {
    <br />    //        if (filterContext.Exception != null)
    <br />    //        {
    <br />    //            filterContext.ExceptionHandled = true;
    <br />    //            filterContext.Result = new RedirectToRouteResult("Default", new RouteValueDictionary(new { controller = "Shared", action = "Error" }));
    <br />    //        }
    <br />    //    }
    <br />    //}
    <br />    public class VaildateLogin : ActionFilterAttribute
    <br />    {
    <br />        public override void OnActionExecuting(ActionExecutingContext filterContext)
    <br />        {
    <br />            if (!filterContext.HttpContext.User.Identity.IsAuthenticated)
    <br />            {
    <br />                filterContext.Result = new RedirectToRouteResult("Default", new RouteValueDictionary(new { controller = "Manage", action = "AdminLogin" }));
    <br />            }
    <br />        }
    <br />    }
    <br />}
    <br />
  </p>
  
  <p>
    
  </p></pre>
  
  
  <p>
    FilterOK了..就去Controller里使用吧. 
  </p>
  
  
  <pre><pre><p>
  <p>
    <img alt="" align="top" src="http://www.9aw.cn/Images/OutliningIndicators/None.gif" />        [VaildateLogin]   //这里就是使用的Filter验证,记得在using里引用Filter的命名空间.
    <br /><img alt="" align="top" src="http://www.9aw.cn/Images/OutliningIndicators/None.gif" />        public ActionResult AddAdmin()
    <br /><img alt="" align="top" src="http://www.9aw.cn/Images/OutliningIndicators/ExpandedBlockStart.gif" />        {
    <br /><img alt="" align="top" src="http://www.9aw.cn/Images/OutliningIndicators/InBlock.gif" />            //if (!Request.IsAuthenticated)  //这里是开始手动写的..多麻烦...
    <br /><img alt="" align="top" src="http://www.9aw.cn/Images/OutliningIndicators/InBlock.gif" />            //{
    <br /><img alt="" align="top" src="http://www.9aw.cn/Images/OutliningIndicators/InBlock.gif" />            //    return RedirectToAction("AdminLogin");
    <br /><img alt="" align="top" src="http://www.9aw.cn/Images/OutliningIndicators/InBlock.gif" />            //}
    <br /><img alt="" align="top" src="http://www.9aw.cn/Images/OutliningIndicators/InBlock.gif" />            //else
    <br /><img alt="" align="top" src="http://www.9aw.cn/Images/OutliningIndicators/InBlock.gif" />            //{
    <br /><img alt="" align="top" src="http://www.9aw.cn/Images/OutliningIndicators/InBlock.gif" />               cml.BLL.Admin bll = new cml.BLL.Admin();
    <br /><img alt="" align="top" src="http://www.9aw.cn/Images/OutliningIndicators/InBlock.gif" />               ViewData["list_model"] = bll.GetAdminList("", 1);
    <br /><img alt="" align="top" src="http://www.9aw.cn/Images/OutliningIndicators/InBlock.gif" />                return View();
    <br /><img alt="" align="top" src="http://www.9aw.cn/Images/OutliningIndicators/InBlock.gif" />           //}
    <br /><img alt="" align="top" src="http://www.9aw.cn/Images/OutliningIndicators/ExpandedBlockEnd.gif" />          }
  </p>
  
  <p>
    
  </p></pre>
  
  
  <p>
    怎么样.很方便吧.如果是整个Controller下都需要身份验证的话..那就把这个Filter放到最外层的Controller上..这样就不用在每个Action上都写了. 
  </p>
  
  
  <p>
    完工..希望多点人来学习asp.net mvc..要不然教程太少了.好东西也太少了. 
  </p>
  
  
  <p>
    from <a href="http://www.9aw.cn/post/2009/07/06/asp-net-mvc-Filter-Forms.aspx">http://www.9aw.cn/post/2009/07/06/asp-net-mvc-Filter-Forms.aspx</a>
  </p>