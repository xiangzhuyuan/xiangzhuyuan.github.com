---
title: 在ASP.NET中调用存储过程方法新解
author: mathewxiang
layout: post
permalink: >
  /2010/02/%e5%9c%a8asp-net%e4%b8%ad%e8%b0%83%e7%94%a8%e5%ad%98%e5%82%a8%e8%bf%87%e7%a8%8b%e6%96%b9%e6%b3%95%e6%96%b0%e8%a7%a3/
categories:
  - 默认
---
<div>
  <div>
    <h1>
      <font style="FonT-siZe: 16px">在使用.NET的过程中，数据库访问是一个很重要的部分，特别是在B/S系统的构建过程中，数据库操作几乎成为了一个必不可少的操作。调用存储过程实现数据库操作使很多程序员使用的方法，而且大多数的程序员都是能使用存储过程就使用存储过程，很少直接使用SQL语句，所以存储过程是很有用而且很重要的。<br /><br /><br /> 　　<b>存储过程简介</b><br /><br /><br /> 　　简单的说，存储过程是由一些SQL语句和控制语句组成的被封装起来的过程，它驻留在数据库中，可以被客户应用程序调用，也可以从另一个过程或触发器调用。它的参数可以被传递和返回。与应用程序中的函数过程类似，存储过程可以通过名字来调用，而且它们同样有输入参数和输出参数。<br /><br /><br /> 　　根据返回值类型的不同，我们可以将存储过程分为三类：返回记录集的存储过程，<br /> 返回数值的存储过程（也可以称为标量存储过程），以及行为存储过程。顾名思义，返回记录集的存储过程的执行结果是一个记录集，典型的例子是从数据库中检索出符合某一个或几个条件的记录；返回数值的存储过程执行完以后返回一个值，例如在数据库中执行一个有返回值的函数或命令；最后，行为存储过程仅仅是用来实现数据库的某个功能，而没有返回值，例如在数据库中的更新和删除操作。<br /><br /><br /> 　　<b>使用存储过程的好处</b><br /><br /><br /> 　　相对于直接使用SQL语句，在应用程序中直接调用存储过程有以下好处：<br /><br /><br /> 　　(1)减少网络通信量。调用一个行数不多的存储过程与直接调用SQL语句的网络通信量可能不会有很大的差别，可是如果存储过程包含上百行SQL语句，那么其性能绝对比一条一条的调用SQL语句要高得多。<br /><br /><br /> 　　(2)执行速度更快。有两个原因：首先，在存储过程创建的时候，数据库已经对其进行了一次解析和优化。其次，存储过程一旦执行，在内存中就会保留一份这个存储过程，这样下次再执行同样的存储过程时，可以从内存中直接调用。<br /><br /><br /> 　　(3)更强的适应性：由于存储过程对数据库的访问是通过存储过程来进行的，因此数据库开发人员可以在不改动存储过程接口的情况下对数据库进行任何改动，而这些改动不会对应用程序造成影响。<br /><br /><br /> 　　(4) 布式工作：应用程序和数据库的编码工作可以分别独立进行，而不会相互压制。<br /><br /><br /> 　　由以上的分析可以看到，在应用程序中使用存储过程是很有必要的。<br /><br /><br /> 　　<b>两种不同的存储过程调用方法</b><br /><br /><br /> 　　为了突出新方法的优点，首先介绍一下在.NET中调用存储过程的“官方”方法。另外，本文的所有示例程序均工作于SqlServer数据库上，其它情况类似，以后不再一一说明。本文所有例子均采用C#语言。<br /><br /><br /> 　　要在应用程序中访问数据库，一般性的步骤是：首先声明一个数据库连接SqlConnection，然后声明一个数据库命令SqlCommand，用来执行SQL语句和存储过程。有了这两个对象后，就可以根据自己的需要采用不同的执行方式达到目的。需要补充的是，不要忘记在页面上添加如下的引用语句：using<br /> System.Data.SqlClient。<br /><br /><br /> 　　就执行存储过程来说，如果执行的是第一类存储过程，那么就要用一个DataAdapter将结果填充到一个DataSet中，然后就可以使用数据网格控件将结果呈现在页面上了；如果执行的是第二和第三种存储过程，则不需要此过程，只需要根据特定的返回判定操作是否成功完成即可。<br /><br /><br /> 　　(1)执行一个没有参数的存储过程的代码如下：<br /><br /></font>
    </h1>
  </div>
</div>

<table border="1" bordercolor="#CCCCCC" width="90%" bgcolor="#E3E3E3" align="center">
  <tr>
    <td>
      <font style="FonT-siZe: 16px">SqlConnection conn=new<br /> SqlConnection(“connectionString”);<br /><br /> SqlDataAdapter da = new SqlDataAdapter();<br /><br /> da.SelectCommand = new SqlCommand();<br /><br /> da.SelectCommand.Connection = conn;<br /><br /> da.SelectCommand.CommandText = “NameOfProcedure”;<br /><br /> da.SelectCommand.CommandType =<br /> CommandType.StoredProcedure;</font>
    </td>
  </tr>
</table>

  
<font style="FonT-siZe: 16px">　　然后只要选择适当的方式执行此处过程，用于不同的目的即可。<br /><br /><br /> 　　(2)执行一个有参数的存储过程的代码如下（我们可以将调用存储过程的函数声明为ExeProcedure(string<br /> inputdate)）：<br /><br /></font>

<table border="1" bordercolor="#CCCCCC" width="90%" bgcolor="#E3E3E3" align="center">
  <tr>
    <td>
      <font style="FonT-siZe: 16px">SqlConnection conn=new<br /> SqlConnection(“connectionString”);<br /><br /> SqlDataAdapter da = new SqlDataAdapter();<br /><br /> da.SelectCommand = new SqlCommand();<br /><br /> da.SelectCommand.Connection = conn;<br /><br /> da.SelectCommand.CommandText = “NameOfProcedure”;<br /><br /> da.SelectCommand.CommandType = CommandType.StoredProcedure;<br /><br /> （以上代码相同，以下为要添加的代码）<br /><br /> param = new SqlParameter(“@ParameterName”,<br /> SqlDbType.DateTime);<br /><br /> param.Direction = ParameterDirection.Input;<br /><br /> param.Value = Convert.ToDateTime(inputdate);<br /><br /> da.SelectCommand.Parameters.Add(param);</font>
    </td>
  </tr>
</table>

  
<font style="FonT-siZe: 16px">　　这样就添加了一个输入参数。若需要添加输出参数：<br /><br /></font>

<table border="1" bordercolor="#CCCCCC" width="90%" bgcolor="#E3E3E3" align="center">
  <tr>
    <td>
      <font style="FonT-siZe: 16px">param = new<br /> SqlParameter(“@ParameterName”, SqlDbType.DateTime);<br /><br /> param.Direction = ParameterDirection.Output;<br /><br /> param.Value = Convert.ToDateTime(inputdate);<br /><br /> da.SelectCommand.Parameters.Add(param);</font>
    </td>
  </tr>
</table>

  
<font style="FonT-siZe: 16px">　　若要获得参储过程的返回值：<br /><br /></font>

<table border="1" bordercolor="#CCCCCC" width="90%" bgcolor="#E3E3E3" align="center">
  <tr>
    <td>
      <font style="FonT-siZe: 16px">param = new<br /> SqlParameter(“@ParameterName”, SqlDbType.DateTime);<br /><br /> param.Direction = ParameterDirection.ReturnValue;<br /><br /> param.Value = Convert.ToDateTime(inputdate);<br /><br /> da.SelectCommand.Parameters.Add(param);</font>
    </td>
  </tr>
</table>

  
<font style="FonT-siZe: 16px">　　从上面的代码我们可以看出，当存储过程比较多或者存储过程的参数比较多时，这种方法会大大影响开发的速度；另外一方面，如果项目比较大，那么这些用于数据库逻辑的函数在以后的维护中也是一个很大的负担。那么，有没有一种改进的方法可以解决这个问题呢？想到在执行没有参数的存储过程时只需要传入一个存储过程的名字就可以调用相应的存储过程，而且在SqlServer数据库中我们可以直接在查询分析器中敲入“存储过程名（参数列表）”样的字符串就可以执行存储过程，那么，是否可以把这种思想应用到应用程序中呢？<br /><br /><br /> 　　于是在编译器中键入相应代码。这些代码是在调用不带参数的存储过程的代码的基础上改的。具体代码如下：<br /><br /></font>

<table border="1" bordercolor="#CCCCCC" width="90%" bgcolor="#E3E3E3" align="center">
  <tr>
    <td>
      <font style="FonT-siZe: 16px">SqlConnection conn=new<br /> SqlConnection(“connectionString”);<br /><br /> SqlDataAdapter da = new SqlDataAdapter();<br /><br /> da.SelectCommand = new SqlCommand();<br /><br /> da.SelectCommand.Connection = conn;<br /><br /> da.SelectCommand.CommandText =<br /> “NameOfProcedure（’para1’,’para2’,para3）”;<br /><br /> da.SelectCommand.CommandType =<br /> CommandType.StoredProcedure;</font>
    </td>
  </tr>
</table>

  
<font style="FonT-siZe: 16px">　　为了使代码更具有代表性，要调用的存储过程的第一个和第二个参数都为字符串类型，第三个参数为整型。执行以后发现，完全可以达到预期的效果！<br /><br /><br /> 　　<b>两种调用方法的比较</b><br /><br /> 　　<br /><br /> 　　通过比较我们可以看到，第二种方法具有一个很明显的优点，那就是可以提高开发速度，节省开发时间，而且代码容易维护，在一定程度上也减少了系统大小。但是，由于对存储过程参数的处理比较笼统，如果要获取输出参数或者得到存储过程的返回值，这种方法就不能满足需要了。虽然如此，但是，这种方法毕竟可以让开发人员少些很大一部分的代码。如果不需要获取输出参数和返回值，那么几乎可以做到“一劳永逸”。因此在实际的程序开发中，这种方法还是具有一定的实用价值的。</font>